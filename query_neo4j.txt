
CREATE CONSTRAINT ON (provincia:Provincia) ASSERT provincia.name IS UNIQUE
CREATE CONSTRAINT ON (regione:Regione) ASSERT regione.name IS UNIQUE
CREATE CONSTRAINT ON (data:Data) ASSERT data.value IS UNIQUE
CREATE CONSTRAINT ON (positivi:Positivi) ASSERT positivi.value IS UNIQUE


CALL apoc.load.json("file:///regioni.json") YIELD value AS v
MERGE (r:Regione {name: v.name})
FOREACH (n IN v.neighbors |
  MERGE (neighbor:Regione {name: n})
  MERGE (r)-[:CONFINA_CON]-(neighbor)
)
RETURN *


CALL apoc.load.json("file:///province.json") YIELD value AS v
MERGE (provincia:Provincia {name: v.name})
FOREACH (n IN v.neighbors |
  MERGE (neighbor:Provincia {name: n})
  MERGE (provincia)-[:CONFINA_CON]-(neighbor)
)
RETURN *

CALL apoc.load.json("file:///province.json") YIELD value AS v
MATCH (provincia:Provincia {name:v.name}),(regione:Regione {name:v.regione})
MERGE (provincia)-[:PROVINCIA_DI]->(regione)
RETURN *

MATCH (n)
DETACH DELETE n //per eliminare tutti i nodi

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-province.csv" AS csvLine
MATCH (provincia:Provincia { name: csvLine.denominazione_provincia })
SET provincia.sigla = csvLine.sigla_provincia,provincia.latidudine = csvLine.lat,provincia.longitudine = csvLine.long
RETURN *


LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-province.csv" AS csvLine 
MERGE (data:Data {value: csvLine.data })

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-province.csv" AS csvLine 
MERGE (positivi:Positivi {value: toInteger(csvLine.totale_casi)})


LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-province.csv" AS csvLine
MATCH (provincia:Provincia {name: csvLine.denominazione_provincia}),(positivi:Positivi {value: toInteger(csvLine.totale_casi)})
MERGE (provincia)-[:POSSIEDE]->(positivi)
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-province.csv" AS csvLine
MATCH (data:Data {value:csvLine.data}),(positivi:Positivi {value: toInteger(csvLine.totale_casi)}),(provincia:Provincia{name:csvLine.denominazione_provincia})
MERGE (positivi)-[:POSITIVI_PROV_NEL_GIORNO{value:provincia.name}]->(data)
RETURN *


MATCH p=()-[r:POSSIEDE]->() DELETE r // eliminare relationship




cut -d, -f1,4,5,6,7,8,9,10,11,13,14,15,18,19 /Applications/GitHub/BigDataProgetto2/Dataset/nope.csv  > /Applications/GitHub/BigDataProgetto2/Dataset/dpc-covid19-regioni.csv

sostituzione ; with ,

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (regione:Regione { name: csvLine.denominazione_regione })
SET regione.latidudine = csvLine.lat,regione.longitudine = csvLine.long
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine 
MERGE (positivi:Positivi {value: toInteger(csvLine.deceduti)})

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine 
MERGE (data:Data {value: csvLine.data })

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine 
MERGE (positivi:Positivi {value: toInteger(csvLine.totale_casi)})

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine 
MERGE (positivi:Positivi {value: toInteger(csvLine.tamponi)})

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (regione:Regione {name: csvLine.denominazione_regione}),(positivi:Positivi {value: toInteger(csvLine.totale_casi)})
MERGE (regione)-[:POSSIEDE_POSITIVI]->(positivi)
RETURN *


LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (data:Data {value:csvLine.data}),(positivi:Positivi {value: toInteger(csvLine.totale_casi)}),(regione:Regione{name:csvLine.denominazione_regione})
MERGE (positivi)-[:POSITIVI_REG_NEL_GIORNO{value:regione.name}]->(data)
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (regione:Regione {name: csvLine.denominazione_regione}),(positivi:Positivi {value: toInteger(csvLine.tamponi)})
MERGE (regione)-[:HA_EFFETTUATO_TAMPONI]->(positivi)
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (data:Data {value:csvLine.data}),(positivi:Positivi {value: toInteger(csvLine.tamponi)}),(regione:Regione{name:csvLine.denominazione_regione})
MERGE (positivi)-[:TAMPONE_NEL_GIORNO{value:regione.name}]->(data)
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (regione:Regione {name: csvLine.denominazione_regione}),(positivi:Positivi {value: toInteger(csvLine.deceduti)})
MERGE (regione)-[:POSSIEDE_DECEDUTI]->(positivi)
RETURN *

LOAD CSV WITH HEADERS FROM "file:///dpc-covid19-regioni.csv" AS csvLine
MATCH (data:Data {value:csvLine.data}),(positivi:Positivi {value: toInteger(csvLine.deceduti)}),(regione:Regione{name:csvLine.denominazione_regione})
MERGE (positivi)-[:DECEDUTI_NEL_GIORNO{value:regione.name}]->(data)
RETURN *

match (n:Positivi)-[:HA_EFFETTUATO_TAMPONI]-(r:Regione) with r,max(n.value) as mxt match (n: Positivi)-[:POSSIEDE_POSITIVI]-(r:Regione) with r,max(n.value) as mx, mxt  return r.name as regione , mx as positivi,mxt as tamponi order by mx DESC Limit 5


match (n:Positivi)-[:POSSIEDE]-(p:Provincia) with p,max(n.value) as mx return p.name,mx order by mx DESC limit 5

MATCH (start:Provincia {name: 'Milano'}), (end:Provincia {name: 'Torino'})
CALL gds.alpha.shortestPath.write({
  nodeProjection: 'Provincia',
  relationshipProjection: {
    CONFINA_CON: {
      type: 'CONFINA_CON',
      properties: 'cost',
      orientation: 'UNDIRECTED'
    }
  },
  startNode: start,
  endNode: end,
  relationshipWeightProperty: 'cost',
  writeProperty: 'sssp'
})
YIELD nodeCount, totalCost
RETURN nodeCount,totalCost

//delete relationship

MATCH (n)-[r:DECEDUTI_NEL_GIORNO]->()
DELETE r


// deceduti totali nella fase uno per ogni regione in ordine decrescente

match (d:Data)-[:POSITIVI_NEL_GIORNO{value:r.name}]-(g:Numero)-[:POSSIEDE_POSITIVI]-(r:Regione)-[:POSSIEDE_DECEDUTI]-(p:Numero)-[:DECEDUTI_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-05-03'
with r,p.value as mx,g.value as gmx,d.value as data
return r.name as regione,mx as deceduti_totali,gmx as positivi_totali,data order by deceduti_totali DESC

//deceduti totali nella fase due per ogni regione in ordine decrescente

match (r:Regione)-[:POSSIEDE_DECEDUTI]-(p:Positivi)-[:DECEDUTI_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-05-03'
with r,p.value as valore_fase1,d.value as data 
match (r:Regione)-[:POSSIEDE_DECEDUTI]-(n:Positivi)-[:DECEDUTI_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-06-15'
with r,n.value-valore_fase1 as valore_fase2,d.value as data
match (r:Regione)-[:REG_POSSIEDE_POSITIVI]-(p:Positivi)-[:POSITIVI_REG_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-05-03'
with r,valore_fase2,p.value as positivi_fase1 
match (r:Regione)-[:REG_POSSIEDE_POSITIVI]-(n:Positivi)-[:POSITIVI_REG_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-06-15'
with r,valore_fase2,n.value-positivi_fase1 as positivi_fase2,d.value as data
return r.name as regione,positivi_fase2 as positivi_totali_fase,valore_fase2 as deceduti_totali_fase2,data 
order by deceduti_totali_fase2 DESC


//media tamponi di tutte le regioni effettuati nella fase 1

match (n:Positivi)-[:TAMPONE_NEL_GIORNO]-(d:Data) where d.value='2020-05-03' return sum(n.value)/21 as media_tamponi,d.value as data_fase1


//somma tamponi di tutte le regioni effettuati nella fase 1 e 2

match (n:Positivi)-[:TAMPONE_NEL_GIORNO]-(d:Data) where d.value='2020-04-28' return sum(n.value) as somma_tamponi,d.value as data
UNION match (r:Regione)-[:HA_EFFETTUATO_TAMPONI]-(p:Positivi)-[:TAMPONE_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-04-28'
with r,p.value as valore_fase1 
match (r:Regione)-[:HA_EFFETTUATO_TAMPONI]-(n:Positivi)-[:TAMPONE_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-06-13'
with r,n.value-valore_fase1 as valore_fase2,d.value as data
return sum(valore_fase2) as somma_tamponi,data

//somma positivi di tutte le regioni individuati nella fase 1 e 2

match (r:Regione)-[:POSSIEDE]-(n:Positivi)-[:POSITIVI_NEL_GIORNO{value:r.name}]-(d:Data) where d.value='2020-05-03' return sum(n.value) as somma_positivi,d.value as data
UNION match (r:Regione)-[:POSSIEDE]-(p:Positivi)-[:POSITIVI_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-05-03'
with r,p.value as valore_fase1 
match (r:Regione)-[:POSSIEDE]-(n:Positivi)-[:POSITIVI_NEL_GIORNO{value:r.name}]-(d:Data)
where d.value='2020-06-15'
with r,n.value-valore_fase1 as valore_fase2,d.value as data
return sum(valore_fase2) as somma_positivi,data

//variazione percentuale dopo esodo del 7 marzo

match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Palermo"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Palermo" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Palermo"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Palermo"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Palermo" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Palermo"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Palermo"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data 
UNION
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Caserta"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Caserta" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Caserta"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Caserta"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Caserta" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Caserta"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Caserta"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Napoli"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Napoli" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Napoli"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Napoli"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Napoli" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Napoli"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Napoli"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Lecce"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Lecce" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Lecce"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Lecce"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Lecce" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Lecce"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Lecce"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Teramo"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Teramo" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Teramo"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Teramo"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Teramo" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Teramo"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Teramo"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Catania"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Catania" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Catania"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Catania"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Catania" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Catania"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Catania"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Bari"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Bari" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Bari"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Bari"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Bari" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Bari"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Bari"  
return provincia,((g.value-valore_iniziale)/valore_iniziale)*100 as variazione_percentuale,d.value as data
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Vibo Valentia"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-02-24" AND p.name="Vibo Valentia" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Vibo Valentia"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-07" AND p.name=provincia  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data 
UNION 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Vibo Valentia"}]-(n:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-08" AND p.name="Vibo Valentia" 
with n.value as valore_iniziale,p.name as provincia 
match(d:Data)-[:POSITIVI_NEL_GIORNO{value:"Vibo Valentia"}]-(g:Positivi)-[:POSSIEDE]-(p:Provincia) 
where d.value="2020-03-23" AND p.name="Vibo Valentia"  
return provincia,((g.value-valore_iniziale)/1)*100 as variazione_percentuale,d.value as data
